# 冒號定義

之前我們看到了 `+` 、 `-` 、 `f+` 、 `f-` 等指令，這些是系統內建的指令。現在讓我們定義自己的指令。這個指令在安裝的章節已經定義過。輸入時請注意 Forth 使用空格來解析使用者的輸入，因此指令 `."` 之後要有空格，指令 `;` 之前也要有空格：

```
rf> : hello ." Hello World!" ;
 ok
```
測試一下新定義的指令。

```
rf> hello
Hello World! ok
```

這個指令是使用冒號 (`:`) 定義出來的。因此被稱為冒號定義指令 (colon definition)。冒號定義指令相當於其他程式語言的副程式或函式。

冒號 `:` 定義了一個新指令，在它之後的 hello 是這個新指令的名稱。名稱之後到 `;` 之前的部份是這個指令的行為。分號 `;` 結束了這個新的定義。

指令 `."` 編譯了它之後一直到 `"` 的宇串，然後，當 hello 執行時，這個字串被印出來。

在前幾章們學會如何使用 Forth 的整數、浮點數及比較邏輯運算指令來進行運算。在以下幾節，我們將使用自行定義的冒號定義指令來處理更複雜的運算。

### 本節指令集

為了描述 `:` 及 `."` 這類之後必須接其他資料的指令，我們在堆疊效果的括弧中以引號表達指令之後所需的資料。

| 指令 | 堆疊效果及指令說明                        | 口語唸法 |
|-----|----------------------------------------|--------|
| `:` | ( "name" -- ) &emsp; | colon |
| `;` | ( -- ) &emsp; | semicolon |
| `."` | ( "text" -- ) &emsp; | dot-quote |

## 資料堆疊指令

Forth 使用堆疊存放資料。但是用堆疊計算時，常會出現困境，使得我們明明看到堆疊上有我們想要的資料，卻苦於無法使用。解決的方法是堆疊指令。以下我們透過一個又一個的小問題，讓我們理解這些指令。

### 複製堆疊頂端的數

我們先以一個小小的問題開始：設計一個指令計算整數的平方。

從前幾章我們學到可以這樣計算 3 的平方：`3 3 *`。現在我們希望能設計一個名為 `square` 的指令，執行 `3 square` 時，就會計算出 3 的平方。因為使用者只放了一個 3 到堆疊上，所以我們必須先將堆疊上的那個 3 複製一次，使得堆疊上有兩個 3 ，才能執行乘法。Forth 提供了一個複製堆疊上整數的指令 `dup`。所以我們可以定義這平方指令如下：
```
rf> : square ( n -- n*n )   dup  ( n n ) *  ( n*n ) ;
 ok
rf> 3 square  .
9  ok
rf> 4 square  .
16  ok
```
注意我們在定義 square 時，在後面加上了堆疊效果的註解，這有助於閱讀的人理解這個指令。當程式複雜時這是一個很好的習慣。在此例中我們還特別在 `dup` 及 `*` 之後加上目前堆疊的註解，讓初學的人知道堆疊的情況。請注意註解以指令 `(` 開頭，以 `)` 結束，`(` 後要有空格。

練習：請設定指令 `cube` 計算堆疊上整數的立方。

### 交換堆疊上的兩個數

假設堆疊上有兩個數字 ( x y )，我們設計一個指令計算 x<sup>2</sup> - y<sup>2</sup>。我們採用以下思路：
```
( x y )     square
( x y*y)    <- 糟糕，x 不在堆疊頂端，如何將它平方？
```
我們需要能將堆疊頂端的兩個數字交換的指令，`swap` 就是這個指令。
```
( x y*y )   swap
( y*y x )   square
( y*y x*x ) <- 糟糕，我們要算的是 x*x-y*y。但是在這兒用減法會得到 y*y-x*x。
```
沒關係，我們可以先減再求負數，如下：
```
( y*y x*x ) -
( y*y-x*x)  negate
( x*x-y*y)
```
或是先交換再減，如下：
```
( y*y x*x ) swap
( x*x y*y ) -
( x*x-y*y )
```
我們使用第一個版本：
```
rf> : x^2-y^2 ( x y -- x^2-y^2 )   square  swap  square  - negate ;
 ok
rf> 3 2 x^2-y^2  .
5  ok
```

注意這兒我們使用 x^2-y^2 做為這個指令的名字。Forth 指令名字不像其他語言的函式名只能是英文字母和數字。重點是指令和指令之前必須以空格隔開。若有必要，你甚至可以用中文命名。你也可以用一個數字命名，以證明自己一個愛惡作劇的小孩。

練習：假設堆疊上有兩個數字 ( x y ) 。設計一個指令計算 x<sup>2</sup> - y 。

### 本節指令集

| 指令 | 堆疊效果及指令說明                        | 口語唸法 |
|-----|----------------------------------------|--------|
| `.s` | (  -- ) &emsp; | dot-s |
| `dup` | (  -- ) &emsp; | dup |
| `drop` | (  -- ) &emsp; | drop |
| `swap` | ( -- ) &emsp; | swap |
| `over` | ( -- ) &emsp; | over |
| `rot` | ( -- ) &emsp; | rot |
| `-rot` | ( -- ) &emsp; | -rot |
| `2dup` | ( -- ) &emsp; | two-dup |
| `2drop` | ( -- ) &emsp; | two-drop |
| `2swap` | ( -- ) &emsp; | two-swap |
| `2over` | ( -- ) &emsp; | two-over |


## 浮點堆疊指令

求 x<sup>2</sup> + 4 x + 1 = 0 的解。

求 x<sup>5</sup> + x<sup>4</sup> + x<sup>3</sup> + x<sup>2</sup> + x + 1 。

### 本節指令集

| 指令 | 堆疊效果及指令說明                        | 口語唸法 |
|-----|----------------------------------------|--------|
| `fdup` | (  -- ) &emsp; | dup |
| `fdrop` | (  -- ) &emsp; | drop |
| `fswap` | ( -- ) &emsp; | swap |
| `fover` | ( -- ) &emsp; | over |
| `frot` | ( -- ) &emsp; | rot |

