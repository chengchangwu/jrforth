# 使用 Forth 進行整數運算

在前一章節中編譯產生的 ./target/release/rf 或是 ./target/debug/rf 只包括了 rtForth 的基本指令集，本節需要更多的指令，因此請以以下方式執行 rtForth：

執行除錯版的 rtForth： 

```
$ ./target/debug/rf lib.fs
```

執行最佳化版本的 rtForth： 

```
$ ./target/release/rf lib.fs
```

在 `rf` 命令後接上 `lib.fs` 會載入 lib.fs 內的指令集。檔案 `lib.fs` 內以 Forth 語言定義了常見的 Forth 指令。有興趣的人可以參考。使用者自行定義的指令集也可以以類似方式載入。假設使用者將自行開發的指令集放在 `path/to/user.fs` 中，而此指令集會使用到 `lib.fs` 內的指令，則可以以下方式執行 `rf` 以載入指令：

```
$ ./target/release/rf lib.fs path/to/user.fs
```

有載入指令集的情形下，rf 不會印出以下訊息：

```
rtForth v0.3.0, Copyright (C) 2018 Mapacode Inc.
Type 'bye' or press Ctrl-D to exit.
```

這是考慮到也許使用者想顯示自訂的顯示訊息。

-------------------------------------
## 整數運算

在 `rf>` 提示後輸入 `2 17 + .` 後按 Enter， 

```
rf> 2 17 + .
19  ok
rf> 
```
這兒發生了什麼事？首先 Forth 是直譯式語言，內建[直譯器](https://zh.wikipedia.org/wiki/%E7%9B%B4%E8%AD%AF%E5%99%A8) (英文：interpreter) 。當執行 `rf` 時，rtForth 會起動外層直譯器 (outer interpreter) ，先印出 `rf>`，等待使用者輸入，再一個字 (word) 一個字的，從輸入緩衝區 (input buffer) 掃描 (scan) 使用者的輸入，在字典 (word list) 中查詢字的定義 (definition) 並執行。完成後顯示 `ok`，告訴使用者執行成功。若失敗則印出錯誤訊息。然後再印出提示字串 (prompt) `rf>` 請使用者繼續輸入。

Forth 的字和字是以空白或是換行符號隔開的。因此 `2 17 + .` 裡面一共有四個字。`2` 和 `17` 是數字。而 `+` 和 `.` 是已經在字典中定義好的指令 (instruction) 。

當直譯器無法在字典中找到這個字，比如 `2` 時，會將這個字轉換成數字 (number)，存放在某記憶體中。這塊記憶體被稱為資料堆疊 (data stack)。稱為堆疊的原因是，這些轉成數字的資料會依次序排列，新來的被堆在舊的上面。就像下圖：

```
Data stack |    |
           +----+
           | 17 | 疊頂(Top)
           +----+
           |  2 |
           +----+
```
也可以左右方式呈現，

```
           +---+----+--
Data Stack | 2 | 17 |
           +---+----+--
                疊頂
                (Top)
```

或是為了方便，在程式中採用 `( 2 17 )` 這樣的註解呈現。

在上述例子中，`+` 從疊頂拿了兩個整數 `2` 和 `17`，相加後將結果 `19` 放回疊頂。所以堆疊的變化如下：

```
Data stack |    |
           +----+
           | 17 |    +     |    |
           +----+   ===>   +----+
           |  2 |          | 19 |
           +----+          +----+
```

在程式中以 `( 2 17 -- 19 )` 的註解方式呈現堆疊的效果。 

### 本節指令集

| 指令 | 堆疊效果           | 說明                        | 口語唸法 |
|-----|-------------------|-----------------------------|--------|
| `+` | ( n1 n2 -- n1+n2 )| 將資料堆疊上的最後的兩個整數相加，結果放回堆疊 | plus   |
| `.` | ( n -- )          | 印出資料堆疊上最後的整數，並將它從堆疊上移除 | dot |
| `(` | ( -- )            | 註解，因為是指令，之後必須接一個空白。會忽略這空白之後一直到下一個右括弧 ) 之間的文字 | paren |

---------------
## 更多的整數運算

TODO

### 本節指令集

| 指令 | 堆疊效果           | 說明                        | 口語唸法 |
|-----|-------------------|-----------------------------|--------|
| `-` | ( n1 n2 -- n1-n2 )|  | minus   |
| `*` | ( n1 n2 -- n1*n2 )          |  | star |
| `/` | ( n1 n2 -- quotient )            |  | slash |
| `mod` | ( n1 n2 -- remainder )            |  | mod |
| `/mod` | ( n1 n2 -- remainder quotient )            |  | slash-mod |
| `abs` | ( -- )            |  |  |
| `negate` | ( -- )            |  |  |
| `min` | ( -- )            |  |  |
| `max` | ( -- )            |  |  |

-------------
## 本章重點整理

* 外層直譯器 (outer interpreter)
* 資料堆疊 (data stack)
* 字 (word)
* 指令 (instruction)
* 字典或指令集  (word list)
* 定義 (definition)
* 輸入緩衝區 (input buffer)
* 掃描 (scan)
* 輸出緩衝區 (output buffer)
* 整數 (integer)

-------------------------------------
## 本章指令集

| 指令 | 堆疊效果           | 說明                        | 口語唸法 |
|-----|-------------------|-----------------------------|--------|
| `+` | ( n1 n2 -- n1+n2 )| 將資料堆疊上的最後的兩個整數相加，結果放回堆疊 | plus   |
| `.` | ( n -- )          | 印出資料堆疊上最後的整數，並將它從堆疊上移除 | dot |
| `(` | ( -- )            | 註解，因為是指令，之後必須接一個空白。會忽略這空白之後一直到下一個右括弧 ) 之間的文字 | paren |
