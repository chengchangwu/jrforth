# 浮點運算

浮點數 (floating point) 是電腦用來表示實數的方式。浮點數不是實數，只能近似實數。這產生種種問題。因此，如果你是位工作上需要處理浮點數的工程師，務必閱讀以下文件：

* David Goldberg 的 [What Every Computer Scientist Should Know About Floating-Point Arithmetic](https://docs.oracle.com/cd/E19957-01/806-3568/ncg_goldberg.html)

Forth 提供浮點運算能力，浮點運算類似整數運算，但有以下不同，

* 輸入浮點數必須有字母 `e`。字母 `e` 後的整數代表 10 的指數。若沒有整數，指數為 0。所以 `1e` 是 1.0 &times; 10<sup>0</sup> 也就是 1.0。2e3 是 2.0 &times; 10<sup>3</sup> 也就是 9.0 。
以下都是正確的浮點輸入：`1e` `1.e` `1.e0` `+1.23e-1` `-1.23e+1`。
* 四則運算指令以 `f` 開頭。比如 `f+`、`f-`、`f*`、`f/`。
* 沒有和 `mod` 及 `/mod` 對應的指令，但有求次方的指令 `f**`，其堆疊效果為 ( F: f1 f2 -- f1<sup>f2</sup>)。
* 資料堆疊放的是整數，浮點數放在另一個浮點堆疊 (floating point stack) 上。
* 浮點數的堆疊效果表示法是 ( F: before -- after )。

讓我們測試一下。

例一：輸入 `1e` `1.e` `1.e0` `+1.23e-1` `-1.23e+1` 並以 `f.` 印出來。
```
rf> 1e f.  1.e f.  1.e0 f.  +1.23e-1 f.  -1.23e+1 f.
1.0000000 1.0000000 1.0000000 0.1230000 -12.3000000  ok
```

例二：以浮點計算 7 + (6 &times; 5<sup>2</sup> + 3)
```
rf> 5e 2e f** 6e f* 3e f+ 7e f+ f.
160.0000000  ok
```

例三：以浮點計算 1/(3<sup>2</sup>)
```
rf> 1e 3e 2e f** f/  f.
0.1111111  ok
```

### 本節指令集

| 指令 | 堆疊效果           | 說明                        | 口語唸法 |
|-----|-------------------|-----------------------------|--------|
| `f.` | ( F:&nbsp; r -- ) | 印出浮點堆疊上最後的浮點數，並將它從堆疊上移除 | f-dot |
| `f+` | ( F:&nbsp; r1 r2 -- r1+r2 )| 將浮點堆疊上的 r1 加上 r2，將結果放回浮點堆疊 | f-plus |
| `f-` | ( F:&nbsp; r1 r2 -- r1-r2 )| 將浮點堆疊上的 r1 減去 r2，將結果放回浮點堆疊 | f-minus |
| `f*` | ( F:&nbsp; r1 r2 -- r1*r2 )| 將浮點堆疊上的 r1 乘以 r2，將結果放回浮點堆疊 | f-star |
| `f/` | ( F:&nbsp; r1 r2 -- r1/r2 )| 將浮點堆疊上的 r1 除以 r2，將結果放回浮點堆疊 | f-slash |
| `f**` | ( F:&nbsp; r1 r2 -- r1<sup>r2</sup>)| 求浮點堆疊上的 r1 的 r2 次方，將結果放回浮點堆疊 | f-star-star |

-----------
## 更多的浮點算術指令

如同整數，Forth 提供了類似 `abs` 、 `negate` 、 `max` 、 `min` 的 `fabs` 、 `fnegate` 、 `fmax` 、 `fmin` 。

另外，因浮點數的特性，還提供了對浮點數行四捨五入的 `fround`、求小於等於浮點數的最大整數的 `floor` 及求大於等於浮點數的最小整數的 `fceil` 。注意這三個指令雖說是求整數，但結果仍以浮點數表示。

注意 `fceil` 指令不是 [FORTH 標準](https://forth-standard.org/standard/index) 中的指令，但存在於某些 Forth 系統中 (包括 rtForth)。

練習一下，

例一：100.0/9.0 後四捨五入。
```
rf> 100e 9e f/  fround  f.
11.0000000  ok
```

例二：請問 3.5 介於哪兩個整數之間？
```
rf> 3.5e floor f.  3.5e fceil f.
3.0000000 4.0000000  ok
```

例三：(29/4.05) 和 7 哪一個比較大？
```
rf> 29e 4.05e f/  7e fmax  f.
7.1604938  ok
```

例四：求中位法 -ａbs(3.2-1.7) 和 -1.4 的最小值。 
```
rf> 3.2e 1.7e f-  fabs  fnegate  -1.4e fmin  f.
-1.5000000  ok
```

| 指令 | 堆疊效果           | 說明                        | 口語唸法 |
|-----|-------------------|-----------------------------|--------|
| `fnegate` | ( F:&nbsp; r1 -- r2 ) | 求 r1 的加法反元素。 | f-negate |
| `fabs` | ( F:&nbsp; r1 -- r2 ) | 求 r1 的絕對值 | f-abs |
| `fmax` | ( F:&nbsp; r1 r2 -- r3 ) | 求 r1 和 r2 中較大的數 | f-max |
| `fmin` | ( F:&nbsp; r1 r2 -- r3 ) | 求 r1 和 r2 中較小的數 | f-min |
| `fround` | ( F:&nbsp; r1 -- r2 ) | 將 r1 四捨五入，注意結果仍是浮點數 | f-round |
| `floor` | ( F:&nbsp; r1 -- r2 ) | 求小於等於 r1 的最大整數，注意結果仍是浮點數 | floor |
| `fceil` | ( F:&nbsp; r1 -- r2 ) | 求大於等於 r1 的最小整數，注意結果仍是浮點數 | f-ceil |

---------------
## 開根號和三角函數 

| 指令 | 堆疊效果           | 說明                        | 口語唸法 |
|-----|-------------------|-----------------------------|--------|
| `fsqrt` | ( F:&nbsp; r1 -- r2 ) | | f-sqrt |
| `fsin` | ( F:&nbsp; r1 -- r2 ) | | f-sine |
| `fcos` | ( F:&nbsp; r1 -- r2 ) | | f-cos |
| `ftan` | ( F:&nbsp; r1 -- r2 ) | | f-tan |
| `fsincos` | ( F:&nbsp; r1 -- r2 r3 ) | | f-sine-cos |
| `fasin` | ( F:&nbsp; r1 -- r2 ) | | f-a-sine |
| `facos` | ( F:&nbsp; r1 -- r2 ) | | f-a-cos |
| `fatan` | ( F:&nbsp; r1 -- r2 ) | | f-a-tan |
| `fatan2` | ( F:&nbsp; r1 r2 -- r3 ) | | f-a-tan-two |

----------------
## 整數和浮點數轉換

| 指令 | 堆疊效果           | 說明                        | 口語唸法 |
|-----|-------------------|-----------------------------|--------|
| `s>f` | ( F:&nbsp; f -- ) | | s-to-f |
| `f>s` | ( F:&nbsp; f -- ) | | f-to-s |

-------------
## 本章重點整理

* 浮點數 (floating point)

-------------------------------------
## 本章指令集
